<dom-module id="socketty-terminal">
    <style>
        #wrapper{
            padding: 15px;
        }
        #main-header{
            margin: 0;
            padding-bottom: 5px;
        }
        #messages{
            font-size: small;
            color: #999;
        }
        #connect-form{
            text-align: center;
            padding-top: 30px;
            padding-bottom: 30px;
        }
        #wait-for-connection{
            text-align: center;
            padding-top: 30px;
            padding-bottom: 30px;
        }
        #terminal-wrapper{
        }
        #toggle-messages{
            cursor: pointer;
        }
        #copy-textarea{
            font-size: x-small;
        }
        #paste-textarea{
            min-height: 200px;
            font-size: small;
        }
        #close-button{
            float:right;
        }
        #paper-progress{
            width: 100%;
        }
    </style>

    <template>
        <div id="wrapper">

        <h4 id="main-header">{{ip}}</h4>
        <div class="form-group">
            <span class="btn-link" id="toggle-messages">Show/hide messages</span>
            <textarea id="messages" class="form-control" rows="2" readonly>Messages:</textarea>
        </div>

        <div class="template" id="connect-form">
            <div class="form-inline">
                <input type="text" class="form-control" placeholder="IP" value="{{ip}}" id="input-ip" />
                <input type="text" class="form-control" placeholder="Username" value="{{username}}" id="input-username" />
                <input type="password" class="form-control" placeholder="Password" id="input-password" />
                <button id="connect-button" class="btn btn-default"><span class="glyphicon glyphicon-console"></span> Connect</button>
            </div>
        </div>

        <div class="template" id="wait-for-connection" style="display:none;">
            <h4>Connecting to host...</h4>
            <paper-progress indeterminate id="paper-progress"></paper-progress>
        </div>

        <div class="template row" id="terminal-open" style="display:none;">
            <div class="col-lg-7">
                <div id="terminal-wrapper"></div>
                <button class="btn btn-danger btn-sm" id="close-button">Close terminal</button>
            </div>
            <div class="col-lg-5">
                <div class="form-group">
                    <textarea class="form-control" id="copy-textarea"></textarea>
                    <button class="btn btn-default btn-sm" id="copy-button">
                        <span class="glyphicon glyphicon-copy"></span> Copy to above
                    </button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="paste-textarea"></textarea>
                    <button class="btn btn-default btn-sm" id="paste-button">
                        <span class="glyphicon glyphicon-paste"></span> Paste first line
                    </button>
                </div>
            </div>
        </div>

        </div>
    </template>
</dom-module>
<script>
    (function () {
        const CREATE_TERMINAL = 1; // From client
        const CREATE_TERMINAL_SUCCESS = 2; // From server
        const CREATE_TERMINAL_FAILURE = 3; // From server

        const READ_TERMINAL_DATA = 4; // From server
        const READ_TERMINAL_DATA_FAILURE = 5; // From server

        const WRITE_TERMINAL_DATA = 6; // From client
        const WRITE_TERMINAL_DATA_FAILURE = 7; // From server

        const CLOSE_TERMINAL = 8; // From client
        const CLOSE_TERMINAL_SUCCESS = 9; // From server
        const CLOSE_TERMINAL_FAILURE = 10; // From server

        const MESSAGE_UNKNOWN = 11; // From server

        var nextTerminalId = 0;
        function Connection(url){
            this.url = url;
            this.terminals = {};
            this.authenticated = false;
            this.reconnect = true;
            this._connect();
        }
        Connection.prototype._connect = function(){
            var that = this;
            this.retry = true;
            this.websocket = new WebSocket(this.url);

            this.websocket.onopen = function(){
                for(var id in that.terminals){
                    if(that.terminals.hasOwnProperty(id)){
                        that.terminals[id].handleConnectionOpen();
                    }
                }
            };
            this.websocket.onclose = function(){
                for(var id in that.terminals){
                    if(that.terminals.hasOwnProperty(id)){
                        that.terminals[id].handleConnectionClose();
                    }
                }

                // Try to reconnect in 5 seconds
                if(that.reconnect){
                    setTimeout(function(){
                        that._connect();
                    }, 5*1000);
                }
            };
            this.websocket.onerror = function(){
                for(var id in that.terminals){
                    if(that.terminals.hasOwnProperty(id)){
                        that.terminals[id].handleConnectionError();
                    }
                }
            };
            this.websocket.onmessage = function(message){
                // Check for plain messages first
                switch(message.data){
                    case 'auth_failure':
                        that.authenticated = false;
                        that.reconnect = false;
                        for(var id in that.terminals){
                            if(that.terminals.hasOwnProperty(id)){
                                that.terminals[id].handleAuthFailure();
                            }
                        }
                        break;
                    case 'auth_success':
                        that.authenticated = true;
                        break;
                    default:
                        var obj = JSON.parse(message.data);
                        if(that.terminals.hasOwnProperty(obj.id)){
                            that.terminals[obj.id].handleMessage(obj.type, obj.value);
                        }
                        break;
                }
            };
        };
        Connection.prototype.register = function(terminal){
            terminal.terminalId = nextTerminalId;
            this.terminals[nextTerminalId] = terminal;
            nextTerminalId++;
        };
        Connection.prototype.unregister = function(terminal){
            delete this.terminals[terminal.terminalId];
        };
        Connection.prototype.send = function(terminal, type, value){
            if(value === undefined){
                value = {};
            }
            if(this.isConnected() && this.isAuthenticated()){
                this.websocket.send(JSON.stringify({'id': terminal.terminalId, 'type': type, 'value': value}));
                return true;
            }

            return false;
        };
        Connection.prototype.isConnected = function(){
            return this.websocket.readyState == WebSocket.OPEN;
        };
        Connection.prototype.isAuthenticated = function(){
            return this.authenticated;
        };

        var connections = {};
        this.SockettyTerminal = Polymer({
            is: 'socketty-terminal',
            properties: {
                url:         {type: String, value: 'wss://localhost:5678'},
                ip:          {type: String, value: ''},
                username:    {type: String, value: ''},
                cols:        {type: Number, value: 120},
                rows:        {type: Number, value: 30},
                screenKeys:  {type: Boolean, value: true},
                useStyle:    {type: Boolean, value: false},
                cursorBlink: {type: Boolean, value: true},
                debug:       {type: Boolean, value: false},
                isRecording: {type: Boolean, value: true}
            },
            ready: function() {
                if(connections.hasOwnProperty(this.url)){
                    this.conn = connections[this.url];
                }else{
                    this.conn = new Connection(this.url);
                    connections[this.url] = this.conn;
                }

                this._isOpen = false;
                this.conn.register(this);
                this._setListeners();
            },
            detached: function(){
                this._closeTerminal();
                this.conn.unregister(this);
            },
            _setListeners: function(){
                var that = this;

                this.querySelector('#connect-button').onclick = function(){
                    if(!that.conn.isConnected()){
                        that._printMessage('Cannot spawn terminal because connection to server is lost');
                        return;
                    }
                    if(!that.conn.isAuthenticated()){
                        that._printMessage('Cannot spawn terminal because authentication failed');
                        return;
                    }

                    var ip = that.querySelector('#input-ip').value;
                    var username = that.querySelector('#input-username').value;
                    var password = that.querySelector('#input-password').value;

                    that._printMessage('Attempting to connect terminal...');
                    that.conn.send(that, CREATE_TERMINAL, {
                        'ip': ip,
                        'username': username,
                        'password': password
                    });

                    that.ip = ip;
                    that._switchTemplate('wait-for-connection');
                };
                this.querySelector('#close-button').onclick = function(){
                    that._closeTerminal();
                    that._switchTemplate('connect-form');
                };
                this.querySelector('#copy-button').onclick = function(){
                    that._copy();
                };
                this.querySelector('#paste-button').onclick = function(){
                    that._paste();
                };
                this.querySelector("#terminal-wrapper").onresize = function(){
                    alert('blarg');
                };
                this.querySelector("#toggle-messages").onclick = function(){
                    var prev = that.$.messages.style.display;
                    that.$.messages.style.display = prev == 'none' ? 'block' : 'none';
                };
            },
            handleMessage: function(type, value){
                switch(type){
                    case CREATE_TERMINAL_SUCCESS:
                        this._printMessage('Terminal connected successfully');
                        this._openTerminal();
                        this._switchTemplate('terminal-open');
                        break;
                    case CREATE_TERMINAL_FAILURE:
                        this._printMessage('Failed to create terminal: ' + value.msg);
                        this._switchTemplate('connect-form');
                        break;
                    case READ_TERMINAL_DATA:
                        this._writeToTerminalFromRemote(value.d);
                        break;
                    case READ_TERMINAL_DATA_FAILURE:
                        this._printMessage('Failed to read from remote: ' + value.msg);
                        break;
                    case WRITE_TERMINAL_DATA_FAILURE:
                        this._printMessage('Failed to write to remote: ' + value.msg);
                        break;
                    case CLOSE_TERMINAL_SUCCESS:
                        this._printMessage('Terminal closed');
                        break;
                    case CLOSE_TERMINAL_FAILURE:
                        this._printMessage('Terminal could not be closed properly: ' + value.msg);
                        break;
                    case MESSAGE_UNKNOWN:
                        this._printMessage('Message was unknown to the server. Weird.');
                        break;
                    default:
                        this._printMessage('Received an unknown message from the server. Throwing it away.');
                        break;
                }
            },
            handleConnectionOpen: function(){
                this._printMessage('Connection established');
            },
            handleConnectionClose: function(){
                this._printMessage('Connection lost');
            },
            handleConnectionError: function(){
                this._printMessage('Connection error');
            },
            handleAuthFailure: function(){
                this._printMessage('Authentication failure');
            },
            _openTerminal: function(){
                var that = this;
                this.recordBuffer = '';
                this.terminal = new Terminal({
                    cols:        this.cols,
                    rows:        this.rows,
                    screenKeys:  this.screenKeys,
                    cursorBlink: this.cursorBlink,
                    debug:       this.debug
                });
                this.terminal.on('data', function(data){
                    that.conn.send(that, WRITE_TERMINAL_DATA, {'d': data});
                });
                this.terminal.open(this.querySelector('#terminal-wrapper'));
                this._isOpen = true;
            },
            _closeTerminal: function(){
                if(this._isOpen){
                    this.terminal.destroy();
                    this.conn.send(this, CLOSE_TERMINAL);
                    this._isOpen = false;
                }
            },
            _writeToTerminalFromRemote: function(data){
                if(this.isRecording){
                    this.recordBuffer += data;
                }

                this.terminal.write(data);
            },
            _switchTemplate: function(id){
                var elems = this.querySelectorAll(".template");

                for(var i = 0; i < elems.length; i++){
                    elems[i].style.display = 'none';
                }

                this.querySelector("#"+id).style.display = 'block';
            },
            _printMessage: function(msg){
                var time = moment().format('HH:mm:ss');
                var element = this.querySelector('#messages');
                element.value += "\n" + time + ': ' + msg;
                element.scrollTop = element.scrollHeight;
            },
            _copy: function(){
                var copyTextarea = this.querySelector('#copy-textarea');
                copyTextarea.value = this.recordBuffer;
                copyTextarea.select();
            },
            _paste: function(){
                var pasteTextarea = this.querySelector('#paste-textarea');
                var text = pasteTextarea.value;
                var indexOfFirstNewline = text.indexOf("\n");
                var firstLine;
                if(indexOfFirstNewline == -1){
                    firstLine = text + "\n";
                    text = '';
                }else{
                    firstLine = text.substr(0, indexOfFirstNewline+1); // plus 1 to get the newline as well
                    text = text.substr(indexOfFirstNewline+1);
                }

                this.terminal.send(firstLine);
                pasteTextarea.value = text;
            },
            pasteExternal: function(text){
                if(this.terminal){
                    this.terminal.send(text);
                }
            }
        });
    })();
</script>